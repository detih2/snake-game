"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ FastAPI
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS (—á—Ç–æ–±—ã frontend –º–æ–≥ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API)
3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤ (–≥—Ä—É–ø–ø —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤)
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å—Ç–∞—Ä—Ç–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
5. –ë–∞–∑–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (health check)

–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å:
    cd backend
    uvicorn app.main:app --reload --port 8000

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:
    - API: http://localhost:8000
    - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs (Swagger)
    - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/redoc
"""

from contextlib import asynccontextmanager

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

import sys
sys.path.insert(0, '..')
from settings import settings

from .database import create_db_and_tables
from .routers import game, leaderboard
from .schemas import HealthResponse


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    –ß—Ç–æ —Ç–∞–∫–æ–µ lifespan?
    ------------------
    –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
    - –ü—Ä–∏ –°–¢–ê–†–¢–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–¥–æ yield)
    - –ü—Ä–∏ –û–°–¢–ê–ù–û–í–ö–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ yield)
    
    –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è:
    - –°–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    - –ó–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
    """
    # === –ö–æ–¥ –ø—Ä–∏ –°–¢–ê–†–¢–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
    print("üöÄ –ó–∞–ø—É—Å–∫ Snake Game API...")
    
    # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç)
    await create_db_and_tables()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞")
    
    yield  # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    
    # === –ö–æ–¥ –ø—Ä–∏ –û–°–¢–ê–ù–û–í–ö–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
    print("üëã –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Snake Game API...")


# === –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä FastAPI ===
app = FastAPI(
    title=settings.app_name,
    description="""
    üêç **Snake Game API** ‚Äî backend –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –∏–≥—Ä—ã "–ó–º–µ–π–∫–∞"
    
    ## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    
    * üéÆ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä
    * üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
    * üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
    * üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä
    
    ## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    
    1. –°—ã–≥—Ä–∞–π—Ç–µ –≤ –∏–≥—Ä—É –Ω–∞ frontend
    2. –ü–æ—Å–ª–µ Game Over —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—é–¥–∞
    3. –°–º–æ—Ç—Ä–∏—Ç–µ —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!
    """,
    version="1.0.0",
    lifespan=lifespan,
    # –ü—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    docs_url="/docs",
    redoc_url="/redoc",
)


# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS ===
# CORS (Cross-Origin Resource Sharing) ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞
# 
# –ü—Ä–æ–±–ª–µ–º–∞:
# - Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost:5173
# - Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost:8000
# –≠—Ç–æ –†–ê–ó–ù–´–ï "origins" (–∏—Å—Ç–æ—á–Ω–∏–∫–∏), –∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É –Ω–∏–º–∏
#
# –†–µ—à–µ–Ω–∏–µ:
# –Ø–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ origins –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É API
# –ò—Å–ø–æ–ª—å–∑—É–µ–º allow_origin_regex –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Vercel preview deployments
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,  # –û—Ç–∫—É–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã
    allow_origin_regex=r"https://.*\.vercel\.app" if settings.cors_allow_all_vercel else None,
    allow_credentials=True,               # –†–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É cookies
    allow_methods=["*"],                  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ HTTP –º–µ—Ç–æ–¥—ã (GET, POST, etc.)
    allow_headers=["*"],                  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)


# === –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã ===
# –ö–∞–∂–¥—ã–π —Ä–æ—É—Ç–µ—Ä ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
app.include_router(game.router)
app.include_router(leaderboard.router)


# === –ë–∞–∑–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã ===

@app.get(
    "/",
    summary="–ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç",
    description="–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ API",
)
async def root() -> dict:
    """
    –ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç.
    
    –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç.
    """
    return {
        "message": "üêç Welcome to Snake Game API!",
        "docs": "/docs",
        "version": "1.0.0",
    }


@app.get(
    "/api/health",
    response_model=HealthResponse,
    summary="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è",
    description="–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
)
async def health_check() -> HealthResponse:
    """
    Health Check ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
    
    –ó–∞—á–µ–º –Ω—É–∂–µ–Ω?
    -----------
    1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å "–∂–∏–≤–æ–π" –∏ –æ—Ç–≤–µ—á–∞–µ—Ç
    2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Kubernetes, Docker, etc.)
    3. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ë–î, –∫—ç—à–∞ –∏ –¥—Ä—É–≥–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    
    Returns:
        –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
    """
    return HealthResponse(
        status="healthy",
        version="1.0.0",
    )
